<!DOCTYPE html>
<head>
    <title>App</title>
    <style>
        #map-canvas {
            width: 500px;
            height: 400px;
        }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="quadkey.js"></script>
    <script>
        var map;
        var overlay;
        weatherOverlay.prototype = new google.maps.OverlayView();
        var cross_score;
        var loc = new google.maps.LatLng(33.711441, -84.347324);

        function initialize() {
            var mapCanvas = document.getElementById('map-canvas');
            var mapOptions = {
                center: loc,
                zoom: 10,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(mapCanvas, mapOptions);
            var cross_score = 0;
            // Using YQL and JSONP
            $.ajax({
                url: "http://hackathon.weather.com/Maps/jsonserieslist.do",
             
                // The name of the callback parameter, as specified by the YQL service
                jsonp: "cb",
             
                // Tell jQuery we're expecting JSONP
                dataType: "jsonp",
             
                
                // Work with the response
                success: function( response ) {
                    var radarLayers = response.seriesInfo.radar.series;
                    var mostRecentRadar = radarLayers[0];
                    var unixTS = mostRecentRadar.unixDate;

                    // Now we want to overlay on top of the map
                    var quadKey = getQuadKey(33.711441, -84.347324, 1);
                    quadKey = 0;

                    var swBound = new google.maps.LatLng(33.611441, -84.447324);
                    var neBound = new google.maps.LatLng(33.811441, -84.247324);
                    var bounds = new google.maps.LatLngBounds(swBound, neBound);
                    var srcImg = "http://gima.weather.com/TileServer/imgs/radar/u"
                        + unixTS + "/" + quadKey + ".png";
                    console.log(srcImg);

                    overlay = new weatherOverlay(bounds, srcImg, map);

                    // Place markers on the map
                    /*
                    var cross_markers = [
                        new google.maps.Marker({
                            position:new google.maps.LatLng(33.711441,-84.347324),
                            icon:'red_cross.png'
                        }),
                        new google.maps.Marker({
                            position:new google.maps.LatLng(33.611441,-84.447324),
                            icon:'red_cross.png'
                        }),
                    ];
                    */
                    var hospital_markers = [
                        new google.maps.Marker({
                            position:new google.maps.LatLng(33.809372, -84.394597),
                            icon:'hospital.png'
                        }),
                        new google.maps.Marker({
                            position:new google.maps.LatLng(33.768764, -84.386344),
                            icon:'hospital.png'
                        }),
                    ];
                    /*
                    for (var i = 0; i < cross_markers.length; i++) {
                        google.maps.event.addListener(cross_markers[i], 'click', function() {
                            this.setVisible(false);
                            that = this;
                            cross_score++;
                            var currentTimeMillis = new Date().getTime();
                            setTimeout(function(){ that.setVisible(true); }, 3000);
                            //if (currentTimeMillis % 5000 == 0) {
                                
                          

                            console.log(cross_score);
                        });
                        cross_markers[i].setMap(map);
                    }
                    */

                    for (var i = 0; i < hospital_markers.length; i++) {
                        google.maps.event.addListener(hospital_markers[i], 'click', function() {
                            hospital_score++;
                            console.log(hospital_score);
                        });
                        hospital_markers[i].setMap(map);
                    }

                    // Show places from search
                    var request = {
                        location: loc,
                        radius: '500',
                        query: 'Red Cross'
                    };

                    service = new google.maps.places.PlacesService(map);
                    service.textSearch(request, searchCb);

                    console.log(response); // server response
                    // console.log(radarLayers);
                    // console.log(mostRecentRadar);
                    // console.log(unixTS);
                }
            });
        }

        function searchCb(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                for (var i = 0; i < results.length; i++) {
                    var place = results[i];
                    var cross_marker = new google.maps.Marker({
                        map: map,
                        position:place.geometry.location,
                        icon:'red_cross.png'
                    });
                    google.maps.event.addListener(cross_marker, 'click', function() {
                        score++;
                        console.log(score);
                    });
                    cross_marker.setMap(map);
                }
            }
        }

        function weatherOverlay(bounds, image, map) {

          // Initialize all properties.
          this.bounds_ = bounds;
          this.image_ = image;
          this.map_ = map;

          // Define a property to hold the image's div. We'll
          // actually create this div upon receipt of the onAdd()
          // method so we'll leave it null for now.
          this.div_ = null;

          // Explicitly call setMap on this overlay.
          this.setMap(map);
        }
        weatherOverlay.prototype.onAdd = function() {

          var div = document.createElement('div');
          div.style.borderStyle = 'none';
          div.style.borderWidth = '0px';
          div.style.position = 'absolute';

          // Create the img element and attach it to the div.
          var img = document.createElement('img');
          img.src = this.image_;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.position = 'absolute';
          div.appendChild(img);

          this.div_ = div;

          // Add the element to the "overlayLayer" pane.
          var panes = this.getPanes();
          panes.overlayLayer.appendChild(div);
        };

        weatherOverlay.prototype.draw = function() {

          // We use the south-west and north-east
          // coordinates of the overlay to peg it to the correct position and size.
          // To do this, we need to retrieve the projection from the overlay.
          var overlayProjection = this.getProjection();

          // Retrieve the south-west and north-east coordinates of this overlay
          // in LatLngs and convert them to pixel coordinates.
          // We'll use these coordinates to resize the div.
          var sw = overlayProjection.fromLatLngToDivPixel(this.bounds_.getSouthWest());
          var ne = overlayProjection.fromLatLngToDivPixel(this.bounds_.getNorthEast());

          // Resize the image's div to fit the indicated dimensions.
          var div = this.div_;
          div.style.left = sw.x + 'px';
          div.style.top = ne.y + 'px';
          div.style.width = (ne.x - sw.x) + 'px';
          div.style.height = (sw.y - ne.y) + 'px';
        };

        // The onRemove() method will be called automatically from the API if
        // we ever set the overlay's map property to 'null'.
        weatherOverlay.prototype.onRemove = function() {
          this.div_.parentNode.removeChild(this.div_);
          this.div_ = null;
        };
        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
    <script>
    /*
        var script = document.createElement('script');
        script.src = "http://hackathon.weather.com/Maps/imgs/radar/u1435108800000/0.png";
        document.getElementsByTagName('head')[0].appendChild(script);
        function eqfeed_callback(response) {
            map.data.addGeoJson(response);
        }
    */
    </script>
    </head>
    <body>
        <h1>Cloud Clicker</h1>
        <p>Score: </p>
        <div id="map-canvas"></div>
    </body>
</body>
</html>